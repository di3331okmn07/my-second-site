<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>競馬 期待値シミュレーター</title>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, sans-serif;
  margin: 0;
  padding: 15px;
  background: #f5f5f5;
}

h2 {
  text-align: center;
  margin-bottom: 15px;
}

.card {
  background: white;
  padding: 15px;
  border-radius: 12px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  margin-bottom: 15px;
}

label {
  font-size: 14px;
  font-weight: bold;
}

input {
  width: 100%;
  padding: 10px;
  margin: 5px 0 12px 0;
  font-size: 16px;
  border-radius: 8px;
  border: 1px solid #ccc;
}

button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 10px;
  border: none;
  margin-top: 8px;
}

.calc-btn {
  background: #1976d2;
  color: white;
}

.sim-btn {
  background: #424242;
  color: white;
}

.result {
  font-size: 15px;
  line-height: 1.6em;
}

.positive { color: #2e7d32; font-weight: bold; }
.negative { color: #c62828; font-weight: bold; }
</style>
</head>

<body>

<h2>競馬EVシミュレーター</h2>

<div class="card">
  <label>オッズ</label>
  <input type="number" id="odds" step="0.01" inputmode="decimal">

  <label>予想勝率（%）</label>
  <input type="number" id="prob" inputmode="decimal">

  <label>賭け金（円）</label>
  <input type="number" id="bet" inputmode="numeric">

  <label>試行回数</label>
  <input type="number" id="trials" value="1000" inputmode="numeric">

  <button class="calc-btn" onclick="calculate()">期待値計算</button>
  <button class="sim-btn" onclick="simulate()">長期シミュレーション</button>
</div>

<div class="card result" id="result">
  結果がここに表示されます
</div>

<script>
function calculate() {
  const odds = parseFloat(oddsEl.value);
  const prob = parseFloat(probEl.value) / 100;
  const bet = parseFloat(betEl.value);

  if (!odds || !prob || !bet) {
    alert("すべて入力してください");
    return;
  }

  const profitIfWin = bet * (odds - 1);
  const expectedValue = (prob * profitIfWin) - ((1 - prob) * bet);
  const roi = (expectedValue / bet) * 100;
  const marketProb = 1 / odds;
  const edge = prob - marketProb;

  const evClass = expectedValue >= 0 ? "positive" : "negative";

  result.innerHTML =
    "<span class='" + evClass + "'>" +
    "期待値: " + expectedValue.toFixed(0) + " 円<br>" +
    "期待回収率: " + roi.toFixed(2) + "%</span><br><br>" +
    "市場確率: " + (marketProb * 100).toFixed(2) + "%<br>" +
    "エッジ: " + (edge * 100).toFixed(2) + "%";
}

function simulate() {
  const odds = parseFloat(oddsEl.value);
  const prob = parseFloat(probEl.value) / 100;
  const bet = parseFloat(betEl.value);
  const trials = parseInt(trialsEl.value);

  if (!odds || !prob || !bet || !trials) {
    alert("すべて入力してください");
    return;
  }

  let bankroll = 0;
  let peak = 0;
  let maxDrawdown = 0;
  let wins = 0;

  for (let i = 0; i < trials; i++) {
    if (Math.random() < prob) {
      bankroll += bet * (odds - 1);
      wins++;
    } else {
      bankroll -= bet;
    }

    if (bankroll > peak) peak = bankroll;
    const drawdown = peak - bankroll;
    if (drawdown > maxDrawdown) maxDrawdown = drawdown;
  }

  result.innerHTML +=
    "<br><br>--- シミュレーション ---<br>" +
    "実測勝率: " + ((wins/trials)*100).toFixed(2) + "%<br>" +
    "最終損益: " + bankroll.toFixed(0) + " 円<br>" +
    "最大DD: " + maxDrawdown.toFixed(0) + " 円";
}

// DOM参照キャッシュ（高速化）
const oddsEl = document.getElementById("odds");
const probEl = document.getElementById("prob");
const betEl = document.getElementById("bet");
const trialsEl = document.getElementById("trials");
const result = document.getElementById("result");
</script>

</body>
</html>
